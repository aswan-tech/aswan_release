<?php
/**
 * BelVG LLC.
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the EULA
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://store.belvg.com/BelVG-LICENSE-COMMUNITY.txt
 *
  /***************************************
 *         MAGENTO EDITION USAGE NOTICE *
 * *************************************** */
/* This package designed for Magento COMMUNITY edition
 * BelVG does not guarantee correct work of this extension
 * on any other Magento edition except Magento COMMUNITY edition.
 * BelVG does not provide extension support in case of
 * incorrect edition usage.
  /***************************************
 *         DISCLAIMER   *
 * *************************************** */
/* Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future.
 * ****************************************************
 * @category   Belvg
 * @package    Belvg_FacebookFree
 * @copyright  Copyright (c) 2010 - 2011 BelVG LLC. (http://www.belvg.com)
 * @license    http://store.belvg.com/BelVG-LICENSE-COMMUNITY.txt
 */

  
$_customerEmail = Mage::getSingleton("checkout/session")->getQuote()->getCustomerEmail();
if($_customerEmail == null) {
	$_customerEmail = Mage::getSingleton('core/session')->getExisingCustomer();
}
?>

<div id="failed-msg" style="display:none;"><p style="font-weight:bold;color:red;">Please Fill either of the details to continue checkout</p></div>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->toHtml() ?></div>

<form method="post" id="login-form">
	<div class="sgn-error fl fs14 c-032 validation-advice" style="display:none;" id="error">You are redirecting on delivery page.</div>
										
	<div class="loginpan">
		<h3>Enter Your Email Address*</h3>
		<input type="text" name="login[username]" id="cust-email" title="Email Address" onKeyPress="javascript:onClickText(this,'Email Address');" onclick="javascript:onClickText(this,'Email Address');" onblur="javascript:onBlurText(this,'Email Address');" class="cklargefield-email required-entry validate-email wdth" value="<?php if(empty($_customerEmail) || $_customerEmail == ''){echo 'Email Address';}else{echo $_customerEmail;} ?>" />
		
		<ul>
		<li>
		<input type="radio" name="radio" id="checkout-i-have-pwd" class="radiobut" onclick="swithContinue('checkout-i-have-pwd');" value="1" />
			<label for="one">
			I have a account and password
			<span>(Sign in to your account for a faster checkout)</span>
			</label>
		</li>
		<li>
		<div id="userpass" style="display:none;">
		  <input type="password" name="login[password]" class="cklargefield-email required-entry validate-password wdth" id="pass" title="<?php echo $this->__('Password') ?>" value="Password" onblur="javascript:onBlurText(this,'Password');" onclick="javascript:onClickText(this,'Password');" />
		  <a href="<?php echo $this->getBaseUrl('') . 'customer/account/forgotpassword/'; ?>" >Forgot Password?</a> </div>
		
		</li>
		<li>
		<input type="radio" name="radio" id="checkout-guest-checkout" class="radiobut" onclick="swithContinue('checkout-guest-checkout');" value="2" />
		<label for="two">
		Continue as a guest
		<span>(No password or registration required)</span>
		</label>
		</li>
		</ul>
		<a href="javascript:void(0);" type="button" name="btnSubmit" id="btnSubmit" class="gobutton" title="<?php echo $this->__('CONTINUE') ?>" ><?php echo $this->__('CONTINUE') ?></a>
	
		<div id="login-loader" style="display:none;padding:10px;">&nbsp;&nbsp;<img src="<?php echo $this->getSkinUrl('images/ajax-loader.gif') ?>"></div>
	</div>
	<div class="divider"></div>
	<div class="loginsocial">
	<h3>Login with</h3>

		<a id="checkout-connect-with-fb" class="ckfb-btn fl gtm-track" href="javascript:void(0);" onclick="return fblogin();">
            <img src="<?php echo $this->helper('facebookfree/active')->getLoginImg() ?>" alt="<?php echo $this->__('facebook connect') ?>">
        </a>
<?php echo $this->getLayout()->createBlock('inchoo_googleconnect/button')->setTemplate('inchoo/googleconnect/button.phtml')->toHtml();?>
	</div>
</form>

<script type="text/javascript">
jQuery(function(){jQuery(".signInbox input[type=checkbox]").uniform();});
jQuery(function(){jQuery(".signInbox input[type=radio]").uniform();});

function LoginFunction(){

	var loginform = new VarienForm('login-form', true);	
	var custemail = jQuery("#cust-email").val();
	
	if(loginform.validator.validate()){
		var formData = jQuery( "#login-form" ).serialize();
		jQuery('#login-loader').show();
		jQuery.ajax({
			url: "<?php echo $this->getUrl('onestepcheckout/ajax/ajaxlogincheckout/') ?>",
			data: formData,
			type:'POST',
			success: function(data){
				if(data == '1'){
					jQuery("#error").show();
					window.location = "<?php echo $this->getUrl('onestepcheckout/index/') ?>";
				}
				else{
					jQuery("#error").html(data).show();
				}								
				jQuery('#login-loader').hide();
			}
		});
	}
}

jQuery("#cust-email").keypress(function(event){
	if(event.keyCode == 13){
		event.preventDefault();
		guestFunction();
	}
});

function guestFunction(){
	var guestemail = jQuery("#cust-email").val();
	var guestform = new VarienForm('login-form', true);
	if(guestform.validator.validate()){
		var login = jQuery.ajax({
			url: "<?php echo $this->getUrl('onestepcheckout/index/continueGuest/') ?>",
			data: 'value='+guestemail,
			type:'POST',
			beforeSend: function() {
				jQuery('#login-loader').show();
			},
			success: function(data){
				if(data == '1') {
					jQuery("#steptwo").hide();
					jQuery('#login-loader').hide();
					jQuery("#error").html("Your email id is blocked").show();
				}
				else {
					jQuery("#checkoutleft .pager ul li").removeClass("current");
					jQuery("#checkoutleft .pager ul li:nth-child(2)").addClass("current");
					jQuery("#stepone").hide();
					jQuery("#steptwo").show();
					jQuery(".input-email .cutomer-email").val(guestemail);						
					jQuery('#login-loader').hide();
					jQuery("#promocode-section").hide();
					jQuery("#checkout-delivery").removeClass('ck-delivery').addClass('ck-delivery-ac');
				}
			},
			error: function(xhr, textStatus, errorThrown){
				alert('Ajax request failed reloading page');
				jQuery('#login-loader').hide();
				window.location.reload();
			}
		});
	}
}

function onBlurText(object,value){
	if(object.value == ''){
		object.value = value;
	}
}
function onClickText(object,value){
	if(object.value == value){
		object.value = '';
	}
}

function swithContinue(fldId){
	var isChecked = jQuery("#"+fldId).val();        
	jQuery("#"+fldId).attr('checked','checked');
	if(isChecked == 1) {            
		jQuery("#pass").removeAttr('disabled');
		jQuery("#userpass").show();
		jQuery("#btnSubmit").attr('onclick','LoginFunction();');
	}
	else if(isChecked == 2){
		jQuery("#pass").attr('disabled','disabled');
		jQuery("#userpass").hide();            
		jQuery("#btnSubmit").attr('onClick','guestFunction();');
		jQuery("#login-form").attr('action','#');
	}
}
</script>
<script>swithContinue('checkout-guest-checkout');</script>
