<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2014 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct(); ?>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->setEscapeMessageFlag(true)->toHtml() ?></div>
<form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
        <?php echo $this->getBlockHtml('formkey') ?>
<div class="no-display">
            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
            <input type="hidden" name="related_product" id="related-products-field" value="" />
        </div>

<div id="detailleft">
<?php echo $this->getChildHtml('media') ?>
</div>

<div id="detailright">
<?php 
	$productReviews = Mage::getModel('review/review')->getCollection();
	$productReviews->addStoreFilter(Mage::app()->getStore()->getId());
    $productReviews->addStatusFilter(Mage_Review_Model_Review::STATUS_APPROVED);
    $productReviews->addEntityFilter('product', $_product->getId());
    $productReviews->setDateOrder();
    $totalReviews = $productReviews->count();
    $rating = Mage::getModel('rating/rating')->getEntitySummary($_product->getId()); 
    $totRating = (int)$rating->getData('count');
    $restRating = (5-$totRating);
    $summaryData = Mage::getModel('review/review_summary')->setStoreId(Mage::app()->getStore()->getId())->load($_product->getId());
    $aggregateRating = '';
	if($summaryData['rating_summary']) {
		$aggregateRating = ' itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating"';
	}
?>
<div class="productreview">
<?php for($i=1; $i<=$totRating; $i++){ ?>	
<span class="active"></span>
<?php } ?>
<?php for($j=1; $j<= $restRating; $j++) { ?>
<span></span>
<?php } ?>
<label <?php echo $aggregateRating; ?>><?php echo $totRating; ?> Ratings / Reviews</label>
<p><a href="#readreview" class="fancybox">Read reviews</a> | <a href="#writereview" class="fancybox">Write reviews</a></p>
<?php if($totRating) { ?>							        
	<meta itemprop="ratingValue" content="<?php echo ($summaryData['rating_summary']*5)/100; ?>"/>
	<meta itemprop="ratingCount" content="<?php echo $totRating; ?>"/>
<?php } ?>    
<!--Read review start-->
<div id="readreview" class="globlepopup">
<h2><?php echo $totalReviews ?> (Reviewed by <?php echo $totalReviews ?> Customers)</h2>
<?php foreach($productReviews as $reviews) { ?>
<div class="readrow">
<h3><?php echo $reviews->getData('title'); ?></h3>
<h4>By <strong><?php echo $reviews->getData('nickname'); ?></strong> from <strong><?php echo $reviews->getData('location'); ?></strong><br />
Posted on <strong><?php echo $reviews->getData('created_at'); ?></strong></h4>
<p><?php echo $reviews->getData('detail'); ?></p>
</div>
<?php } ?>
</div>
<!--Read review close-->

<!--Write review start-->

<div id="writereview" class="globlepopup">
<h2>Write a Review</h2>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr id="error-msg" style="display:none;">
    <td colspan="2">Star (*) marked fields are mandatory.</td>
</tr>
<tr>
<td width="100"><strong>Rating</strong></td>
<td><div class="starrate">
<label for="radio1"><input type="radio" value="1" name="ratings" id="radio1"></label>
<label for="radio2"><input type='radio' value="2" name="ratings" id="radio2"></label>
<label for="radio3"><input type='radio' value="3" name="ratings" id="radio3"></label>
<label for="radio4"><input type='radio' value="4" name="ratings" id="radio4"></label>
<label for="radio5"><input type='radio' value="5" name="ratings" id="radio5"></label>
</div></td>
</tr>
<tr>
    <td width="100"><label>Nick Name <strong>*</strong></label></td>
    <td><input type="text" name="nickname" id="nickname_field" /></td>
  </tr>
  <tr>
    <td><label>Your Location <strong>*</strong></label></td>
    <td><input type="text" name="location" id="location_field" /></td>
  </tr>
   <tr>
    <td><label>Review Title <strong>*</strong></label></td>
    <td><input type="text" id="summary_field" name="title" /></td>
  </tr>
  <tr>
    <td><label>Review comment:</label>
	<ul>
		<li>How you use the product</li>
		<li>Things that are great about it</li>
		<li>Things that aren't great about it</li>
	</ul>
	</td>
    <td><textarea id="review_field" name="detail"></textarea></td>
  </tr>
   <tr>
    <td><label>Email address <strong>*</strong></label></td>
    <td><input type="text" id="email_field" name="email" /></td>
  </tr>
   <tr>
    <td></td>
    <td><a href="#" onclick="submitRating('<?php echo $this->getBaseUrl() ?>review/product/postreview', '<?php echo $_product->getId(); ?>')" class="go">Submit</a></td>
  </tr>
</table>

</div>
<!--Write review close-->
</div>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_sharing_toolbox productshare"></div>
<h2 itemprop="name"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></h2>
<?php 
$price = Mage::helper('core')->currency($_product->getPrice(),true,false);    
$specialPrice = Mage::helper('core')->currency($_product->getFinalPrice(),true,false);
$_price = Mage::helper('core')->currency($_product->getPrice(),false,false);    
$_specialPrice = Mage::helper('core')->currency($_product->getFinalPrice(),false,false);
?>
<h3 itemprop="offers" itemscope="" itemtype="http://schema.org/Offer">
<?php if($_product->isSaleable()) { ?>
<link itemprop="availability" href="http://schema.org/InStock" />	
<?php } ?>
	
<?php 
	if($_price > $_specialPrice) {
		echo '<u>'.$price.'</u>';
	}
        
if($_specialPrice < $_price):
$discount = 100-(round (($_specialPrice / $_price) * 100));
echo '<strong>'.$discount.'% off</strong>'; ?>
<?php endif;// Discount percent output end ?>
<?php if($_price ==$_specialPrice) {
         echo '<span>'.$price.'</span>';
      }
      else { 
        echo '<span>'.$specialPrice.'</span>';
     }?>
<hr>
<meta itemprop="price" content="<?php echo ( ($specialPrice == $price) ? $price : $specialPrice ); ?>"/>
<meta itemprop="priceCurrency" content="INR"/>
</h3>

<?php //echo $this->getReviewsSummaryHtml($_product, false, true)?>
<?php //echo $this->getChildHtml('alert_urls') ?>
<?php //echo $this->getChildHtml('product_type_data') ?>

    <?php if ($_product->getDescription()):?>
        <div class="prodescription">
        <p itemprop="description"><?php echo $_helper->productAttribute($_product, nl2br($_product->getDescription()), 'description') ?></p>
        </div>
    <?php endif;?>

<?php if (!$this->hasOptions()):?>
                        <div class="add-to-box">
                            <?php if($_product->isSaleable()): ?>
                                <?php echo $this->getChildHtml('addtocart') ?>
                            <?php endif; ?>
                            <?php echo $this->getChildHtml('addto') ?>
                        </div>
                    <?php else:?>
                        <?php if ($_product->isSaleable() && $this->hasOptions() && $this->getChildChildHtml('container1') ):?>
                            <div class="options-container-small">
                                <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
                            </div>
                        <?php else: ?>
                            <?php echo $this->getChildHtml('addto') ?>
                        <?php endif;?>
                    <?php endif; ?>



     <?php if ($_product->isSaleable() && $this->hasOptions() && $this->getChildChildHtml('container2') ):?>
            
                <?php echo $this->getChildChildHtml('container2', '', true, true) ?>

        <?php endif;?>
        <!-- additional-detail Start  -->

<!-- you may also like start-->
<?php echo $this->getChildHtml('upsell_products') ?>
<!-- you may also like end-->

        <?php //echo $this->getChildHtml('relatedProducts') ?>
        <?php //echo $this->getChildHtml('productTagList') ?>
        <?php //echo $this->getChildHtml('product_additional_data') ?>
        
        </div>
        </div>
    </form>

<script type="text/javascript">
//<![CDATA[
    var productAddToCartForm = new VarienForm('product_addtocart_form');
    productAddToCartForm.submit = function(button, url) {
        if (this.validator.validate()) {
            var form = this.form;
            var oldUrl = form.action;

            if (url) {
               form.action = url;
            }
            var e = null;
            try {
                this.form.submit();
            } catch (e) {
            }
            this.form.action = oldUrl;
            if (e) {
                throw e;
            }

            if (button && button != 'undefined') {
                button.disabled = true;
            }
        }
    }.bind(productAddToCartForm);

    productAddToCartForm.submitLight = function(button, url){
        if(this.validator) {
            var nv = Validation.methods;
            delete Validation.methods['required-entry'];
            delete Validation.methods['validate-one-required'];
            delete Validation.methods['validate-one-required-by-name'];
            // Remove custom datetime validators
            for (var methodName in Validation.methods) {
                if (methodName.match(/^validate-datetime-.*/i)) {
                    delete Validation.methods[methodName];
                }
            }

            if (this.validator.validate()) {
                if (url) {
                    this.form.action = url;
                }
                this.form.submit();
            }
            Object.extend(Validation.methods, nv);
        }
    }.bind(productAddToCartForm);
//]]>
</script>
<script>
function addToCartByAjax(isRedirect) {
    jQuery('#quickbag').css('display','none');
    jQuery('#quickbag').removeClass('showthis');
    jQuery('#topmenu').removeClass('topshift');
    jQuery('#header').removeClass('bagopen');
    if(isRedirect == "1") {
        document.getElementById("product_addtocart_form").submit();
    }
    else {
        jQuery('#messages_product_view').remove();
        var formData = jQuery('#product_addtocart_form').serializeArray();
        var saveData = jQuery.ajax({
              type: 'POST',
              url: "<?php echo $this->getBaseUrl(); ?>checkout/icart/add",
              data: formData,
              dataType: "text",
              success: function(resultData) {
                  jQuery("#cart-add-to-bag").show();
                  jQuery('#productdetail').prepend('<div id="messages_product_view">'+resultData+'</div>');
                  jQuery('html, body').animate({
                        scrollTop: jQuery("#messages_product_view").offset().top - 150
                    }, 300);
                  jQuery('#ajax-loading').hide();
                   valOpt = 0;
                  jQuery('.productswaches ul li a.select').removeClass('select');
                  jQuery('.productswaches ul li a.active').removeClass('active');
              }
        });
        saveData.error(function() { 
          jQuery("#cart-add-to-bag").show();
          jQuery('#productdetail').prepend('<div id="messages_product_view"><ul class="messages"><li class="error-msg"><ul><li>Something Wrong.Try Again!</li></ul></li></ul></div>');
                  jQuery('#ajax-loading').hide(); 
        });
    }
} 
</script>
<?php
/*
 * Below code for Data Layer only
 */
 
$pObj 			= Mage::getModel( 'catalog/product' )->load( $_product->getId() );
$catIds 		= $pObj->getCategoryIds();
$catId 			= in_array( $catIds[0], array( 3,4,5,6,8,7,256,260) ) ? $catIds[1] : $catIds[0];
$cats 			= Mage::getModel( 'catalog/category' )->load( $catId );
$img_url 		= $this->helper('catalog/image')->init($_product, 'image')->resize('395' , '413');

$_taxHelper  	= Mage::helper('tax');
$_finalPrice 	= $_taxHelper->getPrice($_product, $_product->getFinalPrice());
$_price 		= $_taxHelper->getPrice($_product, $_product->getPrice());

?>
<script type="text/javascript">
dataLayer.push(
    {'PRODUCT_ID': '<?php echo $_product->getSku() ?>'}, 
    {'PRODUCT_NAME': "<?php echo $_product->getName() ?>"},
    {'PRODUCT_IMG_URL': '<?php echo $img_url ?>'},
    {'PRODUCT_PRICE': '<?php echo $_finalPrice ?>'},
    {'PRODUCT_MRP': '<?php echo $_price ?>'},
    {'DEPT_ID': '<?php echo $cats->getParentCategory()->getId() ?>'}, 
    {'DEPT_NAME': "<?php echo $cats->getParentCategory()->getName() ?>"},
    {'CATEGORY_ID': '<?php echo $cats->getId() ?>'}, 
    {'CATEGORY_NAME': "<?php echo $cats->getName() ?>"},
    {'PAGE_TYPE': 'PRODUCT_VIEW'}
);
</script>
