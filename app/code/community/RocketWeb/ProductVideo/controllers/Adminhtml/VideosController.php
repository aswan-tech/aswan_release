<?php/** * RocketWeb * * NOTICE OF LICENSE * * This source file is subject to the Open Software License (OSL 3.0) * that is bundled with this package in the file LICENSE.txt. * It is also available through the world-wide-web at this URL: * http://opensource.org/licenses/osl-3.0.php * * @category   RocketWeb * @package    RocketWeb_ProductVideo * @copyright  Copyright (c) 2011 RocketWeb (http://rocketweb.com) * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0) * @author     RocketWeb */ class RocketWeb_ProductVideo_Adminhtml_VideosController extends Mage_Adminhtml_Controller_Action {	public function indexAction()     {        $this->loadLayout();        $this->renderLayout();	}		public function importAction()    {		error_reporting(E_ALL);				$logger = Mage::getModel('logger/logger');	// logger model object will be created		print "Product Videos Import Process started...<br>";		//$filePath, will define on which folder the required CSV file will be uploaded		$filePath = Mage::getBaseDir('media').DIRECTORY_SEPARATOR.'productvideos'.DIRECTORY_SEPARATOR;		//$filePath = Mage::getStoreConfig('zipcodeimport/paths/zipcodeIn');		//$archiveDir, will define on which folder the required CSV file will be moved after importing all the data		$archiveDir = Mage::getBaseDir('var').DIRECTORY_SEPARATOR.'productvideosArchive'.DIRECTORY_SEPARATOR;		//$archiveDir = Mage::getStoreConfig('zipcodeimport/paths/zipcodeOut');				if(!is_dir($filePath)) {			mkdir($filePath, 0777, true);		}		if(!is_dir($archiveDir)) {			mkdir($archiveDir, 0777, true);		}				if(!$dh  = opendir($filePath)){			$msg = "ERROR::could not open directory for reading!";			$logger->saveLogger('Product Videos', 'Error', 'Productvideos.csv', $msg);			print $msg;			return;					}					$file_array	= array();		//$files_to_be_archived = array();		while (false !== ($filename = readdir($dh))) {			if(stristr($filename, '.csv'))			  $file_array[] = $filename;		}				$files_to_be_archived = $file_array;				//It will check whether any file is available for uploading in $filePath or not		if(count($file_array) == 0){			$msg = 'ERROR::No file available to Archive!';			$logger->saveLogger('Product Videos', 'Error', 'Productvideos.csv', $msg);			print $msg;			return;		}				//Extra code added to pick up the latest file uploaded to import product videos		$file_array_length = count($file_array);		if($file_array_length > 0){			$file_array = $file_array[$file_array_length - 1];		}				$path = $filePath.$file_array;		$pathArchive = $archiveDir.$file_array;				//Open required file in readable mode		$dataStr = fopen($path, "r");		if(!$dataStr){			$msg = 'ERROR::Could not open up the file for reading!';			$logger->saveLogger('Product Videos', 'Error', 'Productvideos.csv', $msg);			print $msg;			return;		}				/*        $headersData = fgetcsv($dataStr);		while ($data = fgetcsv($dataStr)) {			print "<pre>";				print_r($data);			print "</pre>";		}		*/				try {            $temp = Mage::getModel('productvideo/videos');			$temp->loadDataInfile($path, $files_to_be_archived, $filePath ,$archiveDir);			$msg = 'Sucess::Your file has sucessfully been imported!';			//put status in logger after sucessful import			$logger->saveLogger('Product Videos', 'Success', 'Productvideos.csv', $msg);			//moving the processed file to archive folder and remove it from original one			fclose($dataStr);			Mage::log('Product Videos: '.$msg);        } catch (Exception $e) {			Mage::log('Product Videos: '.$e->getMessage());			print $e->getMessage();            die();        }						//extra code added to move all extra files to archive directory		foreach($files_to_be_archived as $archive){			chmod($filePath.$archive, 0777);			copy($filePath.$archive, $archiveDir.$archive);			if (!unlink($filePath.$archive))				echo ("Error deleting $archive<br/>"); 		}		print $msg;	}}